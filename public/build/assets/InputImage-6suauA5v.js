import{r as x,L as ve,q as E,g as ge,c as v,o as g,d,b as _,k as D,t as S,n as ee,N as fe,f as we,y as me,F as ye,m as xe,a as B}from"./vendor-g77w9U1W.js";import be from"./ImageSourceOptionsModal-CoH0kONx.js";import Ie from"./WebcamModal-DO0SO6MI.js";import _e from"./PreviewModal-CvdmynrR.js";import{_ as ke}from"./app-BGMV3ZMb.js";const Ue=["accept","multiple","disabled"],Fe={class:"text-xs text-gray-500 mb-2"},Se=["disabled"],Le={class:"h-full flex flex-col items-center justify-center p-4 text-center"},Me={class:"text-xs text-gray-400 mt-1"},Ce={key:0,class:"mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg"},Re={class:"flex items-center justify-between mb-2"},Ne={class:"text-xs text-blue-600"},Pe={class:"w-full bg-blue-200 rounded-full h-2"},Ee={class:"text-xs text-blue-600 mt-1"},$e={key:1,class:"flex items-center gap-4"},Ve=["src"],We={key:0,class:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center"},Ae=["disabled"],De={key:2,class:"flex space-x-2 overflow-x-auto pb-2 scrollbar-hide"},Be=["disabled"],He=["onClick"],Te=["src"],je={key:0,class:"absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center text-white text-xs font-bold"},ze={key:0},qe={key:1,class:"ml-1"},Ge={key:1,class:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center"},Ke={key:2,class:"absolute inset-0 bg-red-500 bg-opacity-80 flex flex-col items-center justify-center text-white"},Xe={key:2,class:"mt-1 text-xs text-red-600"},Ze={__name:"InputImage",props:{modelValue:{type:Array,default:()=>[]},error:String,inspectionId:{type:[String,Number],required:!0},pointId:{type:[String,Number],required:!0},settings:{type:Object,default:()=>({max_files:1,allowed_types:["jpg","png","jpeg"],camera_aspect_ratio:"3:4",enable_flash:!0,enable_camera_switch:!0,max_size:2048})},point:Object},emits:["update:modelValue","save","removeImage","uploaded","uploadProgress"],setup(m,{emit:te}){const u=m,b=te,H=x(null),$=x(null),I=x(!1),M=x(!1),f=x(!1),r=x([]),k=x(0),y=x(!1),L=x(0),C=x(0),N=x(0),T=ve("imageSourceSetting",x("all")),V=`inspection-${u.inspectionId}-point-${u.pointId}-backup`,F=E(()=>Number(u.settings.max_files)>1),j=E(()=>u.settings.allowed_types.map(e=>`.${e}`).join(", ")),z=E(()=>{const e=u.settings.camera_aspect_ratio.split(":");if(e.length===2){const a=parseFloat(e[0]),t=parseFloat(e[1]);if(!isNaN(a)&&!isNaN(t)&&t!==0)return a/t}return 3/4}),p=E(()=>{const e=[],a=new Set;for(const t of u.modelValue)t.id&&a.add(t.id),e.push({...t,rotation:t.rotation||0,isNew:!1,isUploaded:!0,preview:t.preview||(t.image_path?`/${t.image_path}`:null)});for(const t of r.value)t.id&&a.add(t.id),e.push({...t,isUploading:t.isUploading||!1});return e}),q=e=>e.preview||(e.image_path?`/${e.image_path}`:""),W=()=>{f.value&&(f.value=!1),T.value==="camera"?K():T.value==="gallery"?G():I.value=!0},G=()=>{I.value=!1,H.value.click()},K=()=>{I.value=!1,M.value=!0},ae=()=>{I.value=!1,p.value.length>0&&(f.value=!0)},oe=()=>{M.value=!1,p.value.length>0&&(f.value=!0)},P=()=>{f.value=!1,y.value||(r.value.forEach(e=>{e.preview&&e.preview.startsWith("blob:")&&URL.revokeObjectURL(e.preview)}),r.value=[])},se=e=>new Promise(a=>{const t=new FileReader;t.onload=o=>{const s=new Image;s.onload=()=>{a({file:e,preview:URL.createObjectURL(e),rotation:0,width:s.naturalWidth,height:s.naturalHeight,isNew:!0})},s.onerror=()=>{console.error("Failed to load image for dimensions:",e.name),a({file:e,preview:URL.createObjectURL(e),rotation:0,width:0,height:0,isNew:!0})},s.src=o.target.result},t.readAsDataURL(e)}),ie=e=>{const a=e.name.split(".").pop().toLowerCase();return u.settings.allowed_types.includes(a)},A=async e=>{const t=(u.settings.max_size||2048)*1024;return new Promise(o=>{const s=new Image,c=new FileReader;c.onload=l=>{s.onload=()=>{const n=document.createElement("canvas"),i=n.getContext("2d"),h=Math.max(s.width,s.height);n.width=h,n.height=h,i.fillStyle="white",i.fillRect(0,0,h,h);const w=(h-s.width)/2,U=(h-s.height)/2;i.drawImage(s,w,U,s.width,s.height);let R=.9;const Q=()=>{n.toBlob(O=>{if(O.size>t&&R>.1)R-=.1,Q();else{const he=new File([O],e.name,{type:"image/jpeg",lastModified:Date.now()});o(he)}},"image/jpeg",R)};Q()},s.src=l.target.result},c.readAsDataURL(e)})},re=async e=>{const a=Array.from(e.target.files);if(!a.length){I.value=!1,p.value.length>0&&(f.value=!0);return}try{const t=a.filter(i=>!ie(i));if(t.length>0){const i=t.map(h=>h.name.split(".").pop()).join(", ");alert(`File type not allowed: ${i}. Allowed types: ${u.settings.allowed_types.join(", ")}`),e.target.value="";return}const o=p.value.length,s=u.settings.max_files-o,c=await Promise.all(a.slice(0,s).map(async i=>await A(i))),l=await Promise.all(c.map(se)),n=F.value?l:l.slice(0,1);F.value?r.value.push(...n):(r.value.forEach(i=>{i.preview&&i.preview.startsWith("blob:")&&URL.revokeObjectURL(i.preview)}),r.value=n),I.value=!1,n.length>0?(k.value=Math.max(0,p.value.length-n.length),f.value=!0):p.value.length>0&&(f.value=!0),e.target.value=""}catch(t){console.error("Error processing selected images:",t),alert("Failed to process selected images. Please try again."),I.value=!1,p.value.length>0&&(f.value=!0)}},le=async e=>{const a=p.value.length;if(!F.value||a<u.settings.max_files)try{const t=await A(e),o=new Image;o.onload=()=>{const s={file:t,preview:URL.createObjectURL(t),rotation:0,width:o.naturalWidth,height:o.naturalHeight,isNew:!0};F.value?r.value.push(s):(r.value.forEach(c=>{c.preview&&c.preview.startsWith("blob:")&&URL.revokeObjectURL(c.preview)}),r.value=[s]),M.value=!1,I.value=!1,k.value=p.value.length-1,f.value=!0},o.src=URL.createObjectURL(t)}catch(t){console.error("Error processing captured image:",t),alert("Failed to process captured image. Please try again.")}else alert(`Maximum ${u.settings.max_files} files allowed.`),M.value=!1,I.value=!1,p.value.length>0&&(f.value=!0)},X=(e=0)=>{k.value=e,f.value=!0},ne=e=>new Promise(a=>{if(e.rotation===0||!$.value){if(!e.isNew&&!e.file){a({file:null,width:e.width,height:e.height,isOriginal:!0});return}a({file:e.file,width:e.width,height:e.height});return}const t=new Image;t.onload=async()=>{try{const o=$.value,s=o.getContext("2d"),c=t.width,l=t.height;let n,i;e.rotation===90||e.rotation===270?(n=l,i=c):(n=c,i=l),o.width=n,o.height=i,s.clearRect(0,0,o.width,o.height),s.translate(o.width/2,o.height/2),s.rotate(e.rotation*Math.PI/180),s.drawImage(t,-c/2,-l/2,c,l),s.setTransform(1,0,0,1,0,0);const h=await new Promise(R=>{o.toBlob(R,"image/jpeg",.9)}),w=new File([h],e.file?e.file.name:`rotated_image_${Date.now()}.jpg`,{type:"image/jpeg"}),U=await A(w);a({file:U,width:n,height:i})}catch(o){console.error("Error processing rotated image:",o),a({file:e.file,width:e.width,height:e.height})}},t.onerror=()=>{console.error("Failed to load image for rotation processing:",e.preview),a({file:e.file,width:e.width,height:e.height})},t.src=e.preview}),de=e=>{try{const a={images:e.map(t=>{var o;return{fileName:((o=t.file)==null?void 0:o.name)||`image-${Date.now()}.jpg`,rotation:t.rotation||0,width:t.width||0,height:t.height||0,timestamp:Date.now()}}),inspectionId:u.inspectionId,pointId:u.pointId};localStorage.setItem(V,JSON.stringify(a))}catch(a){console.error("Error saving backup:",a)}},Z=()=>{localStorage.removeItem(V)},ue=async e=>{y.value=!0;const a=[],t=[];if(!u.pointId){alert("Error: Point ID is missing. Cannot upload image."),y.value=!1;return}try{de(e);for(const o of e){if(!o.isNew&&o.rotation===0&&o.id&&o.image_path){a.push({id:o.id,image_path:o.image_path,width:o.width,height:o.height,rotation:0,preview:o.preview,isUploaded:!0});continue}const{file:s,width:c,height:l,isOriginal:n}=await ne(o);if(n&&!o.isNew){a.push({id:o.id,image_path:o.image_path,width:o.width,height:o.height,rotation:o.rotation||0,preview:o.preview,isUploaded:!0});continue}s&&t.push({file:s,width:c,height:l,rotation:o.rotation||0,originalImage:o})}P(),t.length>0?await ce(t,a):(b("update:modelValue",a),b("save",u.pointId))}catch(o){console.error("Error during image processing:",o),alert("Terjadi error saat memproses gambar. Data tersimpan secara lokal.")}finally{y.value=!1}},ce=async(e,a)=>{N.value=e.length,C.value=0,L.value=0;const t=[...a];let o=0;try{for(let s=0;s<e.length;s++){const c=e[s],l=new FormData;l.append("inspection_id",u.inspectionId),l.append("point_id",u.pointId),l.append("images[]",c.file);const n=r.value.findIndex(i=>{var h;return i.preview===((h=c.originalImage)==null?void 0:h.preview)});n!==-1&&(r.value[n].isUploading=!0,r.value[n].isFailed=!1);try{const h=(await B.post(route("inspections.upload-image"),l,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:w=>{if(w.total){const U=Math.round(w.loaded*100/w.total);L.value=Math.round((s+w.loaded/w.total)/e.length*100),C.value=s+1}}})).data.images;if(h&&h.length>0){const w=h[0];if(t.push({id:w.image_id,image_path:w.path,width:w.width||c.width||0,height:w.height||c.height||0,rotation:c.rotation||0,preview:w.public_url,isUploaded:!0}),n!==-1){const U=r.value.splice(n,1)[0];U.preview&&U.preview.startsWith("blob:")&&URL.revokeObjectURL(U.preview)}o++}}catch(i){console.error(`Error uploading image ${s+1}:`,i),n!==-1&&(r.value[n].isUploading=!1,r.value[n].isFailed=!0)}}o>0&&(b("update:modelValue",t),b("save",u.pointId),b("uploaded",{pointId:u.pointId,images:t,newImagesCount:o})),o===e.length&&Z(),console.log(`✅ Successfully uploaded ${o}/${e.length} images`)}catch(s){console.error("Error in upload process:",s),e.forEach(c=>{const l=r.value.findIndex(n=>{var i;return n.preview===((i=c.originalImage)==null?void 0:i.preview)});l!==-1&&(r.value[l].isUploading=!1,r.value[l].isFailed=!0)})}finally{L.value=0,C.value=0,N.value=0,y.value=!1}},J=async e=>{if(!e||!e.file){console.error("No file to retry upload");return}y.value=!0;const a=[...u.modelValue];try{const t=new FormData;t.append("inspection_id",u.inspectionId),t.append("point_id",u.pointId),t.append("images[]",e.file);const o=r.value.findIndex(l=>l.preview===e.preview);o!==-1&&(r.value[o].isUploading=!0,r.value[o].isFailed=!1);const c=(await B.post(route("inspections.upload-image"),t,{headers:{"Content-Type":"multipart/form-data"}})).data.images;if(c&&c.length>0){const l=c[0];if(a.push({id:l.image_id,image_path:l.path,width:l.width||e.width||0,height:l.height||e.height||0,rotation:e.rotation||0,preview:l.public_url,isUploaded:!0}),o!==-1){const i=r.value.splice(o,1)[0];i.preview&&i.preview.startsWith("blob:")&&URL.revokeObjectURL(i.preview)}b("update:modelValue",a),b("save",u.pointId),b("uploaded",{pointId:u.pointId,images:a,newImagesCount:1}),r.value.some(i=>i.isFailed)||Z(),console.log("✅ Successfully retried upload for 1 image")}}catch(t){console.error("Error retrying upload:",t),previewIndex!==-1&&(r.value[previewIndex].isUploading=!1,r.value[previewIndex].isFailed=!0)}finally{y.value=!1}},pe=e=>{if(e){if(e.id&&!e.isNew)Y(e);else{const a=r.value.findIndex(t=>t.preview&&t.preview===e.preview&&t.isNew||t.id&&t.id===e.id);if(a!==-1){const t=r.value.splice(a,1)[0];t.preview&&t.preview.startsWith("blob:")&&URL.revokeObjectURL(t.preview)}b("update:modelValue",u.modelValue.filter(t=>!(t.id&&t.id===e.id)&&!(t.preview&&t.preview===e.preview)))}k.value>=p.value.length&&(k.value=Math.max(0,p.value.length-1)),p.value.length===0&&P()}},Y=async e=>{var t,o;if(e.id||e.image_path)try{await B.delete(route("inspections.delete-image"),{data:{image_id:e.id,image_path:e.image_path}})}catch(s){console.error("Error deleting image from server:",s),(o=(t=s.response)==null?void 0:t.data)!=null&&o.message?alert(`Failed to delete image from server: ${s.response.data.message}`):alert(`Failed to delete image from server: ${s.message}`);return}e.preview&&e.preview.startsWith("blob:")&&URL.revokeObjectURL(e.preview);const a=u.modelValue.filter(s=>s.id!==e.id);b("update:modelValue",a),r.value=r.value.filter(s=>s.isNew&&e.isNew?s.preview!==e.preview:s.id!==e.id),b("removeImage",{image:e}),f.value&&p.value.length===0?P():f.value&&k.value>=p.value.length&&(k.value=Math.max(0,p.value.length-1))};return ge(()=>{try{localStorage.getItem(V)&&console.log("Found backup images, ready for recovery if needed")}catch(e){console.error("Error loading backup:",e)}}),(e,a)=>(g(),v("div",null,[d("input",{ref_key:"galleryInput",ref:H,type:"file",accept:j.value,class:"hidden",onChange:re,multiple:F.value,disabled:y.value},null,40,Ue),d("canvas",{ref_key:"processingCanvas",ref:$,class:"hidden"},null,512),d("p",Fe,"Foto Maksimal: "+S(m.settings.max_files)+" | Rasio: "+S(m.settings.camera_aspect_ratio),1),p.value.length===0?(g(),v("label",{key:0,onClick:W,class:ee(["block w-full border-2 border-dashed rounded-lg cursor-pointer transition-colors duration-200 h-28",{"border-gray-300 hover:border-indigo-400 bg-gray-50":!0}]),disabled:y.value},[d("div",Le,[a[2]||(a[2]=d("svg",{class:"w-8 h-8 text-gray-400 mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})],-1)),a[3]||(a[3]=d("p",{class:"text-sm text-gray-600 font-medium"},"Upload Image",-1)),d("p",Me,"Tipe: "+S(j.value),1)])],8,Se)):(g(),v("div",{key:1,class:ee(["block w-full rounded-lg transition-colors duration-200 p-2",{"border-2 border-dashed border-indigo-200 bg-indigo-50 h-auto p-2":m.settings.max_files==1,"bg-transparent":m.settings.max_files>1}]),"aria-label":"Image gallery"},[y.value?(g(),v("div",Ce,[d("div",Re,[a[4]||(a[4]=d("span",{class:"text-sm font-medium text-blue-700"},"Mengupload gambar...",-1)),d("span",Ne,S(L.value)+"%",1)]),d("div",Pe,[d("div",{class:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:fe({width:L.value+"%"})},null,4)]),d("p",Ee,S(C.value)+"/"+S(N.value)+" gambar terupload",1)])):_("",!0),m.settings.max_files===1?(g(),v("div",$e,[d("div",{class:"relative flex-shrink-0 w-24 h-24 overflow-hidden rounded-md border border-gray-200 cursor-pointer",onClick:a[0]||(a[0]=t=>X(0))},[d("img",{src:q(p.value[0]),class:"w-full h-full object-cover"},null,8,Ve),p.value[0].isUploading?(g(),v("div",We,a[5]||(a[5]=[d("div",{class:"w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"},null,-1)]))):_("",!0)]),d("button",{onClick:a[1]||(a[1]=me(t=>Y(p.value[0]),["stop"])),type:"button",class:"flex items-center gap-1 text-red-600 font-medium hover:text-red-800 transition-colors",disabled:y.value},a[6]||(a[6]=[d("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.095 21H7.905a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1),we(" Hapus Foto ")]),8,Ae)])):(g(),v("div",De,[F.value&&p.value.length<m.settings.max_files?(g(),v("div",{key:0,class:"flex-shrink-0 flex flex-col items-center justify-center p-2 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-indigo-500 transition-colors w-24 h-24",onClick:W,disabled:y.value},a[7]||(a[7]=[d("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-8 w-8 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),d("p",{class:"mt-1 text-xs text-gray-600"},"Tambah",-1)]),8,Be)):_("",!0),(g(!0),v(ye,null,xe(p.value,(t,o)=>(g(),v("div",{key:t.id||t.preview,class:"relative flex-shrink-0 w-24 h-24 overflow-hidden rounded-md border border-gray-200 cursor-pointer",onClick:s=>t.isFailed?J(t):X(o)},[d("img",{src:q(t),class:"w-full h-full object-cover"},null,8,Te),t.isNew||t.rotation!==0?(g(),v("div",je,[t.isNew?(g(),v("span",ze,"BARU")):_("",!0),t.rotation!==0?(g(),v("span",qe,"ROTASI")):_("",!0)])):_("",!0),t.isUploading?(g(),v("div",Ge,a[8]||(a[8]=[d("div",{class:"w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"},null,-1)]))):_("",!0),t.isFailed?(g(),v("div",Ke,a[9]||(a[9]=[d("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 mb-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[d("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1),d("span",{class:"text-xs font-medium"},"Retry",-1)]))):_("",!0)],8,He))),128))]))],2)),m.error?(g(),v("p",Xe,S(m.error),1)):_("",!0),D(be,{show:I.value,settings:m.settings,onClose:ae,onOpenWebcam:K,onTriggerGallery:G},null,8,["show","settings"]),D(Ie,{show:M.value,"aspect-ratio":z.value,settings:m.settings,point:m.point,onClose:oe,onPhotoCaptured:le},null,8,["show","aspect-ratio","settings","point"]),D(_e,{show:f.value,images:p.value,point:m.point,"initial-index":k.value,"allow-multiple":F.value,"max-files":m.settings.max_files,"is-uploading":y.value,"aspect-ratio":z.value,"upload-progress":L.value,"current-upload":C.value,"total-upload":N.value,onClose:P,onSaveImages:ue,onRemovePreviewImage:pe,onTriggerAddMorePhotos:W,onRetryImage:J},null,8,["show","images","point","initial-index","allow-multiple","max-files","is-uploading","aspect-ratio","upload-progress","current-upload","total-upload"])]))}},tt=ke(Ze,[["__scopeId","data-v-2c51b312"]]);export{tt as default};
